<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>V36.1 - SIREN SNIPER (H1-D1 RADAR)</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 5px 10px; background: #111; display: grid; grid-template-columns: 2fr 1fr; gap: 10px; border-bottom: 2px solid #333; }
        select, button { background: #000; color: #0f0; border: 1px solid #0f0; padding: 8px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 11px; }
        .view-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chart-container { flex: 1; position: relative; border-bottom: 1px solid #222; }
        .status-overlay { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 100; padding: 12px 25px; border-radius: 4px; font-weight: 900; font-size: 14px; text-align: center; min-width: 380px; border: 3px solid #fff; pointer-events: none; }
        
        /* WHALE SIREN MODAL */
        #whale-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; border: 15px solid #fff; }
        #whale-modal h1 { font-size: 45px; margin: 0; color: #fff; text-shadow: 5px 5px #000; animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        #whale-modal .command { font-size: 30px; background: #fff; color: #f00; padding: 15px; margin: 20px 0; font-weight: 900; border: 5px solid #000; }
        #whale-modal button { background: #000; color: #fff; border: 5px solid #fff; font-size: 25px; padding: 20px 50px; cursor: pointer; }

        @keyframes flash-red { 0% { background: #000; } 50% { background: #f00; } 100% { background: #000; } }
        .is-flashing { animation: flash-red 0.2s infinite; }
        .misi-info { position: absolute; bottom: 5px; right: 5px; z-index: 10; background: rgba(0,0,0,0.9); padding: 5px; border: 1px solid #444; font-size: 9px; line-height: 1.3; }
        .tf-ctrl-box { position: absolute; top: 5px; left: 5px; z-index: 10; display: flex; gap: 5px; background: rgba(0,0,0,0.8); padding: 3px; border: 1px solid #0f0; }
    </style>
</head>
<body>
<div id="whale-modal">
    <h1>⚠️ WHALE RADAR ACTIVE ⚠️</h1>
    <div id="whale-command" class="command">TUNGGU ANALISA...</div>
    <div id="whale-details" style="font-size:16px; margin-bottom:20px; color:white; font-weight:bold;"></div>
    <button onclick="stopSiren()">SAYA SUDAH AMBIL POSISI!</button>
</div>

<div class="container">
    <div id="header">
        <select id="symbol"><option value="BTCUSDT">BTC/USDT</option><option value="ETHUSDT">ETH/USDT</option></select>
        <button id="btnConnect">START SIREN ENGINE V36.1</button>
    </div>
    <div class="view-area">
        <div class="chart-container" id="box-top">
            <div id="notif-top" class="status-overlay" style="display:none"></div>
            <div class="tf-ctrl-box">
                <select id="tf-top">
                    <option value="1m">M1</option><option value="5m">M5</option><option value="15m" selected>M15</option>
                    <option value="30m">M30</option><option value="1h">H1</option><option value="4h">H4</option><option value="1d">D1</option>
                </select>
            </div>
            <div id="canvas-top" style="height:100%"></div>
            <div class="misi-info" id="misi-top"></div>
        </div>
        <div class="chart-container" id="box-bottom">
            <div id="notif-bottom" class="status-overlay" style="display:none"></div>
            <div class="tf-ctrl-box">
                <select id="tf-bottom">
                    <option value="1m" selected>M1</option><option value="5m">M5</option><option value="15m">M15</option>
                    <option value="30m">M30</option><option value="1h">H1</option><option value="4h">H4</option><option value="1d">D1</option>
                </select>
            </div>
            <div id="canvas-bottom" style="height:100%"></div>
            <div class="misi-info" id="misi-bottom"></div>
        </div>
    </div>
</div>

<script>
let missions = {}, charts = {}, websocks = {};
let sirenInterval = null;
const colors = { '1h': '#bf00ff', '30m': '#0000ff', '15m': '#ffff00', '5m': '#00ff00', '1m': '#ffffff', '4h': '#ffa500', '1d': '#ff4500' };

function playSiren() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let count = 0;
    sirenInterval = setInterval(() => {
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = count % 2 === 0 ? 'sine' : 'sawtooth';
        o.frequency.value = count % 2 === 0 ? 800 : 1200;
        o.connect(g); g.connect(ctx.destination);
        o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
        o.stop(ctx.currentTime + 0.5);
        count++;
        if(count > 20) stopSiren(); // Berhenti setelah 10 detik otomatis
    }, 500);
}

function stopSiren() {
    clearInterval(sirenInterval);
    document.getElementById('whale-modal').style.display = 'none';
    document.body.classList.remove('is-flashing');
}

function createChart(id) {
    const c = LightweightCharts.createChart(document.getElementById(id), {
        layout: { background: { color: '#000' }, textColor: '#ccc' },
        grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
        timeScale: { timeVisible: true }
    });
    const s = c.addCandlestickSeries({ upColor: '#22c55e', downColor: '#ef4444', borderVisible: false });
    const lines = {};
    for (let tf in colors) { lines[tf] = c.addLineSeries({ color: colors[tf], lineWidth: 2, priceLineVisible: false }); }
    return { c, s, lines };
}

charts.top = createChart('canvas-top');
charts.bottom = createChart('canvas-bottom');

async function syncAll() {
    const sym = document.getElementById('symbol').value;
    const tfs = ['1m', '5m', '15m', '30m', '1h', '4h', '1d'];
    for (let tf of tfs) {
        try {
            const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${tf}&limit=50`);
            const d = await r.json();
            const lastClose = parseFloat(d[d.length-1][4]);
            missions[tf] = parseFloat(d[d.length-2][1]); // Pakai Open price candle sebelumnya sebagai Mission
        } catch(e) {}
    }
    renderMissions();
}

function renderMissions() {
    ['top', 'bottom'].forEach(p => {
        const el = document.getElementById(`misi-${p}`);
        el.innerHTML = "<b>SIREN RADAR:</b>";
        for (let tf in missions) { 
            const color = colors[tf] || '#fff';
            el.innerHTML += `<div style="color:${color}">${tf.toUpperCase()}: ${missions[tf].toFixed(2)}</div>`; 
        }
    });
}

function checkWhaleDanger(p, k) {
    const alerts = [];
    const tfs = ['1h', '4h', '1d'];
    
    tfs.forEach(tf => {
        const target = missions[tf];
        if (target && Math.abs(p - target) > (p * 0.003)) { // Threshold bahaya 0.3%
            if ((p > target && k.c < k.o) || (p < target && k.c > k.o)) {
                alerts.push({ tf: tf, target: target, dir: p > target ? 'SELL' : 'BUY' });
            }
        }
    });

    if (alerts.length > 0 && document.getElementById('whale-modal').style.display !== 'flex') {
        const primary = alerts[alerts.length - 1]; // Ambil TF terbesar
        const modal = document.getElementById('whale-modal');
        document.getElementById('whale-command').innerHTML = `${primary.dir} NOW! (TF ${primary.tf.toUpperCase()})`;
        document.getElementById('whale-details').innerHTML = alerts.map(a => `TARGET ${a.tf.toUpperCase()}: ${a.target.toFixed(2)}`).join('<br>');
        modal.style.display = 'flex';
        document.body.classList.add('is-flashing');
        playSiren();
    }
}

function updateUI(pos, p, k) {
    const tf = document.getElementById(pos === 'top' ? 'tf-top' : 'tf-bottom').value;
    const target = missions[tf] || p;
    const now = Math.floor(Date.now()/1000);

    if (pos === 'bottom') checkWhaleDanger(p, k);

    for (let mTF in colors) { 
        if(missions[mTF]) charts[pos].lines[mTF].setData([{time: now-50000, value: missions[mTF]}, {time: now+50000, value: missions[mTF]}]); 
    }

    const notif = document.getElementById(pos === 'top' ? 'notif-top' : 'notif-bottom');
    notif.className = "status-overlay";
    notif.style.background = p < target ? "rgba(0,180,0,0.9)" : "rgba(180,0,0,0.9)";
    notif.innerHTML = `MOBI: ${p < target ? 'UP' : 'DOWN'}<br>GOAL ${tf.toUpperCase()}: ${target.toFixed(2)}`;
    notif.style.display = "block";
}

async function start(pos) {
    const sym = document.getElementById('symbol').value;
    const tf = document.getElementById(pos === 'top' ? 'tf-top' : 'tf-bottom').value;
    const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${tf}&limit=200`);
    const d = await r.json();
    charts[pos].s.setData(d.map(k => ({ time: k[0]/1000, open: +k[1], high: +k[2], low: +k[3], close: +k[4] })));
    if (websocks[pos]) websocks[pos].close();
    websocks[pos] = new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@kline_${tf}`);
    websocks[pos].onmessage = e => { const k = JSON.parse(e.data).k; charts[pos].s.update({ time: k.t/1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c }); updateUI(pos, +k.c, k); };
}

document.getElementById('btnConnect').onclick = async () => { await syncAll(); start('top'); start('bottom'); };
document.getElementById('tf-top').onchange = () => start('top');
document.getElementById('tf-bottom').onchange = () => start('bottom');
</script>
</body>
</html>
