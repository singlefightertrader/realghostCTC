<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>V35.0 - SNIPER MATHEMATICS (1+1=2)</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 5px 10px; background: #111; display: grid; grid-template-columns: 2fr 1fr; gap: 10px; border-bottom: 2px solid #333; }
        select, button { background: #000; color: #0f0; border: 1px solid #0f0; padding: 8px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 11px; }
        .view-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chart-container { flex: 1; position: relative; border-bottom: 1px solid #222; }
        .status-overlay { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 100; padding: 12px 25px; border-radius: 4px; font-weight: 900; font-size: 14px; text-align: center; min-width: 360px; border: 4px solid #fff; pointer-events: none; }
        .BUY-ALERT { background: #00ff00; color: #000; box-shadow: 0 0 30px #00ff00; }
        .SELL-ALERT { background: #ff0000; color: #fff; box-shadow: 0 0 30px #ff0000; }
        .WAIT-ALERT { background: #333; color: #ff0; border-color: #ff0; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .tp-active { animation: pulse-red 0.3s infinite; font-size: 20px; }
        .misi-info { position: absolute; bottom: 5px; right: 5px; z-index: 10; background: rgba(0,0,0,0.8); padding: 5px; border: 1px solid #444; font-size: 9px; line-height: 1.1; max-height: 120px; overflow-y: auto; }
        .tf-ctrl-box { position: absolute; top: 5px; left: 5px; z-index: 10; display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 2px; border: 1px solid #444; }
        #btnDownload { position: absolute; bottom: 10px; left: 10px; z-index: 1000; border: 1px solid #ffaa00; color: #ffaa00; font-size: 10px; padding: 5px; background: #000; }
    </style>
</head>
<body>
<div class="container">
    <div id="header">
        <select id="symbol"><option value="BTCUSDT">BTC/USDT</option><option value="ETHUSDT">ETH/USDT</option></select>
        <button id="btnConnect">START PROBABILITY ENGINE V35.0</button>
    </div>
    <div class="view-area">
        <div class="chart-container" id="box-top">
            <div id="notif-top" class="status-overlay" style="display:none"></div>
            <div class="tf-ctrl-box">
                <select id="tf-top"><option value="1h">H1</option><option value="30m">M30</option><option value="15m" selected>M15</option><option value="5m">M5</option><option value="1m">M1</option></select>
            </div>
            <div id="canvas-top" style="height:100%"></div>
            <div class="misi-info" id="misi-top"></div>
        </div>
        <div class="chart-container" id="box-bottom">
            <div id="notif-bottom" class="status-overlay" style="display:none"></div>
            <div class="tf-ctrl-box">
                <select id="tf-bottom"><option value="1h">H1</option><option value="30m">M30</option><option value="15m">M15</option><option value="5m">M5</option><option value="1m" selected>M1</option></select>
            </div>
            <div id="canvas-bottom" style="height:100%"></div>
            <div class="misi-info" id="misi-bottom"></div>
            <button id="btnDownload">DOWNLOAD ENTRY LOG (0)</button>
        </div>
    </div>
</div>

<script>
let missions = {}, snr = {}, charts = {}, websocks = {}, lock = { top: false, bottom: false }, entryLog = [];
let achievedMissions = {}; // Untuk pelacakan penghapusan 1 jam

// WARNA SESUAI INSTRUKSI LU
const colors = { '1h': '#bf00ff', '30m': '#0000ff', '15m': '#ffff00', '5m': '#00ff00', '1m': '#ffffff' };

function createChart(id) {
    const c = LightweightCharts.createChart(document.getElementById(id), {
        layout: { background: { color: '#000' }, textColor: '#ccc' },
        grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
        timeScale: { timeVisible: true }
    });
    const s = c.addCandlestickSeries({ upColor: '#22c55e', downColor: '#ef4444', borderVisible: false });
    const lines = {};
    for (let tf in colors) { lines[tf] = c.addLineSeries({ color: colors[tf], lineWidth: 2, priceLineVisible: false }); }
    return { c, s, lines };
}

charts.top = createChart('canvas-top');
charts.bottom = createChart('canvas-bottom');

async function syncAll() {
    const sym = document.getElementById('symbol').value;
    const nowTs = Date.now();
    
    for (let tf in colors) {
        // Hapus misi yang sudah tercapai > 1 jam
        if (achievedMissions[tf] && (nowTs - achievedMissions[tf].time > 3600000)) {
            delete missions[tf];
            delete achievedMissions[tf];
        }

        if (!missions[tf]) {
            try {
                const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${tf}&limit=250`);
                const d = await r.json();
                const last = parseFloat(d[d.length-1][4]);
                let deals = [], hi = [], lo = [];
                d.forEach(k => { hi.push(+k[2]); lo.push(+k[3]); deals.push(+k[1]); });
                snr[tf] = { r: Math.max(...hi), s: Math.min(...lo) };
                
                // Mission Price = Harga yang belum tercapai tapi 'seharusnya' tercapai
                let target = deals.filter(p => Math.abs(p - last) > (last * 0.00015)).sort((a,b) => Math.abs(a-last) - Math.abs(b-last))[0];
                missions[tf] = target || last;
            } catch(e) {}
        }
    }
    renderMissionList();
}

function renderMissionList() {
    ['top', 'bottom'].forEach(p => {
        const el = document.getElementById(`misi-${p}`);
        el.innerHTML = "<b>MISSION PRICES:</b>";
        for (let tf in colors) { if(missions[tf]) el.innerHTML += `<div style="color:${colors[tf]}">${tf.toUpperCase()}: ${missions[tf].toFixed(2)}</div>`; }
    });
}

function updateUI(pos, p, tf, k) {
    const notif = document.getElementById(pos === 'top' ? 'notif-top' : 'notif-bottom');
    const target = missions[tf], s = snr[tf], c = charts[pos], now = Math.floor(Date.now()/1000);
    if(!target || !s) return;

    // Gambar Garis Misi
    for (let mTF in colors) { 
        if(missions[mTF]) c.lines[mTF].setData([{time: now-50000, value: missions[mTF]}, {time: now+50000, value: missions[mTF]}]); 
        else c.lines[mTF].setData([]);
    }

    // Deteksi Misi Tercapai (Hit Target)
    if (Math.abs(p - target) < (p * 0.00005)) {
        achievedMissions[tf] = { time: Date.now(), price: target };
        syncAll(); // Langsung cari misi baru
    }

    if (k.x) lock[pos] = false; 
    if (lock[pos]) return;

    const isBuyZone = p < target && Math.abs(p - s.s) < (p * 0.0012);
    const isSellZone = p > target && Math.abs(p - s.r) < (p * 0.0012);

    if (isBuyZone || isSellZone) {
        lock[pos] = true;
        const action = isBuyZone ? 'BUY' : 'SELL';
        const ts = new Date().toLocaleString('id-ID');
        entryLog.push({ Time: ts, Action: action, TF: tf, Price: p, Target: target });
        document.getElementById('btnDownload').innerText = `DOWNLOAD LOG (${entryLog.length})`;

        notif.className = `status-overlay ${action}-ALERT`;
        notif.innerHTML = `<span class="tp-active">HAJAR ${action}! (1+1=2)</span><br>TARGET: ${target.toFixed(2)}`;
        notif.style.display = "block";
    } else {
        notif.className = "status-overlay WAIT-ALERT";
        notif.innerHTML = `WAITING MATHEMATICAL SETUP...<br>TARGET: ${target.toFixed(2)}`;
        notif.style.display = "block";
    }
}

document.getElementById('btnDownload').onclick = () => {
    let csv = "Time,Action,TF,Price,Target\n";
    entryLog.forEach(l => { csv += `${l.Time},${l.Action},${l.TF},${l.Price},${l.Target}\n`; });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Math_Log_${Date.now()}.csv`; a.click();
};

async function start(pos) {
    const sym = document.getElementById('symbol').value;
    const tf = document.getElementById(pos === 'top' ? 'tf-top' : 'tf-bottom').value;
    const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${tf}&limit=150`);
    const d = await r.json();
    charts[pos].s.setData(d.map(k => ({ time: k[0]/1000, open: +k[1], high: +k[2], low: +k[3], close: +k[4] })));
    if (websocks[pos]) websocks[pos].close();
    websocks[pos] = new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@kline_${tf}`);
    websocks[pos].onmessage = e => {
        const k = JSON.parse(e.data).k;
        charts[pos].s.update({ time: k.t/1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c });
        updateUI(pos, +k.c, tf, k);
    };
}

document.getElementById('btnConnect').onclick = async () => { await syncAll(); start('top'); start('bottom'); setInterval(syncAll, 60000); };
document.getElementById('tf-top').onchange = () => start('top');
document.getElementById('tf-bottom').onchange = () => start('bottom');
</script>
</body>
</html>
