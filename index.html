<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>V35.5 - WHALE REVERSAL SHIELD</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; transition: background 0.1s; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 5px 10px; background: #111; display: grid; grid-template-columns: 2fr 1fr; gap: 10px; border-bottom: 2px solid #333; }
        select, button { background: #000; color: #0f0; border: 1px solid #0f0; padding: 8px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 11px; }
        .view-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chart-container { flex: 1; position: relative; border-bottom: 1px solid #222; }
        
        /* NOTIFIKASI STANDARD */
        .status-overlay { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 100; padding: 12px 25px; border-radius: 4px; font-weight: 900; font-size: 14px; text-align: center; min-width: 360px; border: 4px solid #fff; pointer-events: none; }
        .BUY-ALERT { background: #00ff00; color: #000; }
        .SELL-ALERT { background: #ff0000; color: #fff; }
        .WAIT-ALERT { background: #333; color: #ff0; }

        /* FITUR BARU: WHALE REVERSAL MODAL (HARUS KLIK) */
        #whale-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,0,0,0.8); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #whale-modal h1 { font-size: 50px; margin: 0; color: #fff; text-shadow: 5px 5px #000; }
        #whale-modal p { font-size: 20px; font-weight: 900; color: #000; background: #fff; padding: 10px; }
        #whale-modal button { background: #fff; color: #f00; border: 5px solid #000; font-size: 25px; margin-top: 20px; padding: 15px 40px; }

        @keyframes flash-bg { 0% { background: #000; } 50% { background: #f00; } 100% { background: #000; } }
        .is-flashing { animation: flash-bg 0.2s infinite; }

        .misi-info { position: absolute; bottom: 5px; right: 5px; z-index: 10; background: rgba(0,0,0,0.8); padding: 5px; border: 1px solid #444; font-size: 9px; line-height: 1.1; max-height: 120px; overflow-y: auto; }
        #sync-timer { position: absolute; bottom: 40px; left: 10px; font-size: 8px; color: #0f0; z-index: 10; }
    </style>
</head>
<body>
<div id="whale-modal">
    <h1>⚠️ WHALE REVERSAL! ⚠️</h1>
    <p id="whale-desc">DETEKSI TEKANAN TF BESAR (H1) KE ARAH BAWAH!</p>
    <button onclick="closeWhaleModal()">SAYA PAHAM, STOP KEDIP!</button>
</div>

<div class="container">
    <div id="header">
        <select id="symbol"><option value="BTCUSDT">BTC/USDT</option></select>
        <button id="btnConnect">START DYNAMIC ENGINE V35.5</button>
    </div>
    <div class="view-area">
        <div class="chart-container" id="box-top">
            <div id="notif-top" class="status-overlay" style="display:none"></div>
            <div id="canvas-top" style="height:100%"></div>
            <div class="misi-info" id="misi-top"></div>
        </div>
        <div class="chart-container" id="box-bottom">
            <div id="notif-bottom" class="status-overlay" style="display:none"></div>
            <div id="canvas-bottom" style="height:100%"></div>
            <div class="misi-info" id="misi-bottom"></div>
            <div id="sync-timer">NEXT AUTO-REFRESH: 05:00</div>
        </div>
    </div>
</div>

<script>
let missions = {}, snr = {}, charts = {}, websocks = {}, entryLog = [];
let nextRefresh = 300;
const colors = { '1h': '#bf00ff', '30m': '#0000ff', '15m': '#ffff00', '5m': '#00ff00', '1m': '#ffffff' };

// SOUND ENGINE FIX: Pake Oscillator biar pasti bunyi di semua HP
function playAlertSound() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(880, ctx.currentTime); 
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 1);
}

function createChart(id) {
    const c = LightweightCharts.createChart(document.getElementById(id), {
        layout: { background: { color: '#000' }, textColor: '#ccc' },
        grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
        timeScale: { timeVisible: true }
    });
    const s = c.addCandlestickSeries({ upColor: '#22c55e', downColor: '#ef4444', borderVisible: false });
    const lines = {};
    for (let tf in colors) { lines[tf] = c.addLineSeries({ color: colors[tf], lineWidth: 2, priceLineVisible: false }); }
    return { c, s, lines };
}

charts.top = createChart('canvas-top');
charts.bottom = createChart('canvas-bottom');

async function syncAll() {
    const sym = document.getElementById('symbol').value;
    for (let tf in colors) {
        try {
            const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${tf}&limit=200`);
            const d = await r.json();
            const last = parseFloat(d[d.length-1][4]);
            let deals = [], hi = [], lo = [];
            d.forEach(k => { hi.push(+k[2]); lo.push(+k[3]); deals.push(+k[1]); });
            snr[tf] = { r: Math.max(...hi), s: Math.min(...lo) };
            let untouched = deals.filter(p => Math.abs(p - last) > (last * 0.00015)).sort((a,b) => Math.abs(a-last) - Math.abs(b-last));
            missions[tf] = untouched[0] || last;
        } catch(e) {}
    }
    renderMissions();
    nextRefresh = 300;
}

function closeWhaleModal() {
    document.getElementById('whale-modal').style.display = 'none';
    document.body.classList.remove('is-flashing');
}

function triggerWhaleReversal(p, targetH1) {
    const modal = document.getElementById('whale-modal');
    if (modal.style.display !== 'flex') {
        document.getElementById('whale-desc').innerHTML = `MAGNET H1 TERDETEKSI DI: ${targetH1.toFixed(2)}<br>HARGA SEKARANG: ${p.toFixed(2)}<br>BAHAYA REVERSAL TAJAM!`;
        modal.style.display = 'flex';
        document.body.classList.add('is-flashing');
        playAlertSound();
    }
}

function updateUI(pos, p, tf, k) {
    const notif = document.getElementById(pos === 'top' ? 'notif-top' : 'notif-bottom');
    const target = missions[tf], now = Math.floor(Date.now()/1000);

    // CEK WHALE REVERSAL (TF H1 vs Harga M1)
    const h1Mission = missions['1h'];
    if (h1Mission && Math.abs(p - h1Mission) > (p * 0.0008)) {
        // Jika harga sudah terlalu jauh ninggalin H1, kasih warning keras!
        if ((p > h1Mission && k.c < k.o) || (p < h1Mission && k.c > k.o)) {
             triggerWhaleReversal(p, h1Mission);
        }
    }

    // DRAW MISSION LINES
    for (let mTF in colors) { 
        if(missions[mTF]) charts[pos].lines[mTF].setData([{time: now-50000, value: missions[mTF]}, {time: now+50000, value: missions[mTF]}]); 
    }

    const direction = p < target ? 'UP ↑' : 'DOWN ↓';
    notif.className = "status-overlay WAIT-ALERT";
    notif.innerHTML = `PROBABILITY: ${direction}<br>TARGET: ${target.toFixed(2)}`;
    notif.style.display = "block";
}

// Timer & Start Functions Tetap Sama (Ga Diubah Biar Gak Rusak)
setInterval(() => { if(nextRefresh > 0) nextRefresh--; else syncAll(); }, 1000);
function renderMissions() {
    ['top', 'bottom'].forEach(p => {
        const el = document.getElementById(`misi-${p}`);
        el.innerHTML = "<b>DYNAMIC MISSIONS:</b>";
        for (let tf in colors) { if(missions[tf]) el.innerHTML += `<div style="color:${colors[tf]}">${tf.toUpperCase()}: ${missions[tf].toFixed(2)}</div>`; }
    });
}
async function start(pos) {
    const sym = document.getElementById('symbol').value;
    const tf = pos === 'top' ? '15m' : '1m';
    const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${tf}&limit=150`);
    const d = await r.json();
    charts[pos].s.setData(d.map(k => ({ time: k[0]/1000, open: +k[1], high: +k[2], low: +k[3], close: +k[4] })));
    if (websocks[pos]) websocks[pos].close();
    websocks[pos] = new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@kline_${tf}`);
    websocks[pos].onmessage = e => {
        const k = JSON.parse(e.data).k;
        charts[pos].s.update({ time: k.t/1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c });
        updateUI(pos, +k.c, tf, k);
    };
}
document.getElementById('btnConnect').onclick = async () => { await syncAll(); start('top'); start('bottom'); };
</script>
</body>
</html>
